// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Mesa {
  id        Int       @id @default(autoincrement())
  numero    Int       @unique
  status    String    @default("LIVRE") // LIVRE | OCUPADA | FECHAMENTO
  comandas  Comanda[]
}

model Usuario {
  id        Int      @id @default(autoincrement())
  nome      String
  login     String   @unique
  role      String   // DONO | GERENTE | GARCOM | CAIXA | ADMIN
  senha     String
  pedidos   Pedido[]
  comandas  Comanda[]
  logs      LogStatus[]
}

model Comanda {
  id          Int         @id @default(autoincrement())
  mesaId      Int
  mesa        Mesa        @relation(fields: [mesaId], references: [id])
  usuarioId   Int?        // Quem abriu a comanda
  usuario     Usuario?    @relation(fields: [usuarioId], references: [id])
  status      String      @default("ABERTA") // ABERTA | FECHADA
  total       Float       @default(0.0)
  abertaEm    DateTime    @default(now())
  fechadaEm   DateTime?
  pedidos     Pedido[]
  pagamentos  Pagamento[]

  @@index([status])
  @@index([mesaId])
}

model Pedido {
  id              Int             @id @default(autoincrement())
  comandaId       Int
  comanda         Comanda         @relation(fields: [comandaId], references: [id])
  garcomId        Int?
  garcom          Usuario?        @relation(fields: [garcomId], references: [id])
  status          String          @default("ABERTO") // ABERTO | FINALIZADO | CANCELADO
  criadoEm        DateTime        @default(now())
  itens           PedidoItem[]
  ordensProducao  OrdemProducao[]
}

model Categoria {
  id        Int       @id @default(autoincrement())
  nome      String
  setor     String    // COZINHA | BAR | SOBREMESA
  produtos  Produto[]
}

model Produto {
  id          Int           @id @default(autoincrement())
  nome        String
  categoriaId Int?
  categoria   Categoria?     @relation(fields: [categoriaId], references: [id])
  preco       Float
  ativo       Boolean       @default(true)
  foto        String?
  tipoOpcao   String        @default("padrao")
  sabores     String?
  isDrink     Boolean       @default(false)
  isFood      Boolean       @default(true)
  permitirObservacao Boolean @default(true)
  permiteGeloLimao Boolean  @default(false)
  favorito    Boolean       @default(false)
  ultimoUso   DateTime?     @default(now())
  estoque     Int?          // Se null, estoque é infinito
  esgotado    Boolean       @default(false) // Toggle manual para marcar como indisponível
  itens       PedidoItem[]
}

model PedidoItem {
  id          Int         @id @default(autoincrement())
  pedidoId    Int
  pedido      Pedido      @relation(fields: [pedidoId], references: [id])
  produtoId   Int
  produto     Produto     @relation(fields: [produtoId], references: [id])
  quantidade  Int
  observacao  String?
  status      String      @default("PENDENTE") // PENDENTE | EM_PREPARO | PRONTO
  ordemItens  OrdemItem[]
}

model OrdemProducao {
  id           Int         @id @default(autoincrement())
  pedidoId     Int
  pedido       Pedido      @relation(fields: [pedidoId], references: [id])
  setor        String      // COZINHA | BAR
  status       String      @default("RECEBIDO") // RECEBIDO | EM_PREPARO | PRONTO
  criadaEm     DateTime    @default(now())
  finalizadaEm DateTime?
  itens       OrdemItem[]

  @@index([status])
  @@index([setor])
}

model OrdemItem {
  id              Int           @id @default(autoincrement())
  ordemProducaoId Int
  ordemProducao   OrdemProducao @relation(fields: [ordemProducaoId], references: [id])
  pedidoItemId    Int
  pedidoItem      PedidoItem    @relation(fields: [pedidoItemId], references: [id])
}

model Pagamento {
  id        Int      @id @default(autoincrement())
  comandaId Int
  comanda   Comanda  @relation(fields: [comandaId], references: [id])
  tipo      String   // DINHEIRO | PIX | CARTAO
  valor     Float
  status    String   // PENDENTE | PAGO
  criadoEm  DateTime @default(now())
}

model LogStatus {
  id          Int      @id @default(autoincrement())
  entidade    String
  entidadeId  Int
  status      String
  usuarioId   Int?
  usuario     Usuario? @relation(fields: [usuarioId], references: [id])
  criadoEm    DateTime @default(now())
}

model PrinterConfig {
  id        Int     @id @default(autoincrement())
  setor     String  @unique // COZINHA | BAR | CAIXA
  name      String
  ip        String
  port      Int     @default(9100)
  enabled   Boolean @default(true)
}
